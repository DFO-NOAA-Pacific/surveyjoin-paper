---
title: "Coastwide index of Pacific hake"
author: "Kelli Johnson, Eric Ward"
format: pdf
editor: visual
---

## Data

We are going to pull data from the `surveyjoin` package. We will restrict the data to just PBS and NWFSC samples, because the AFSC occurrences are so sparse.

```{r}
remotes::install_github("DFO-NOAA-Pacific/surveyjoin", "5843afb")
remotes::install_github("pbs-assess/sdmTMB", "d3779e3")
library(surveyjoin)
library(sdmTMB)
library(tidyr)
library(dplyr)

  d <- get_data(common = "north pacific hake", regions = c("pbs", "nwfsc"), years = 2003:2023,
                surveys = c("NWFSC.Combo","SYN HS","SYN QCS","SYN WCHG","SYN WCVI")) |>
    dplyr::group_by(event_id) |>
    slice(1) |>
  as.data.frame()
  
  saveRDS(d, "data_for_modelling_2003_2023.rds")

```

```{r}
d <- dplyr::mutate(d, 
                   lon_mid = (lon_start + lon_end)/2,
                   lat_mid = (lat_start + lat_end)/2) |>
  dplyr::filter(!is.na(lon_mid), !is.na(lat_mid))
d <- add_utm_columns(d, ll_names = c("lon_mid","lat_mid"))

mesh <- make_mesh(d, xy_cols = c("X","Y"), cutoff=20)

mesh$mesh$n
```

```{r}
d$cpue <- d$catch_weight/d$effort
d$fyear <- as.factor(d$year)
```

```{r}
fit <- sdmTMB(cpue ~ 0 + fyear,
              spatial="on",
              spatiotemporal = "AR1",
              mesh = mesh,
              data = d,
              time = "year",
              family = delta_gamma())
sanity(fit) # passes all
saveRDS(fit, "fitted_models/null.rds")
```

```{r}
grid <- rbind(surveyjoin::nwfsc_grid,
surveyjoin::dfo_synoptic_grid) |>
  dplyr::select(-survey_domain_year)
years <- unique(d$year)
# create a combination of grid and years
expanded_grid <- crossing(grid, year = years)
expanded_grid$fyear <- as.factor(expanded_grid$year)

# add UTM -- this is UTM zone 10 / 32610
expanded_grid <- add_utm_columns(expanded_grid, ll_names = c("lon","lat"), utm_crs = get_crs(d, ll_names = c("lon_mid","lat_mid")))
```

```{r}

# BC index
sub <- dplyr::filter(expanded_grid, survey!="WCBTS")
predictions <- predict(fit, newdata = sub, return_tmb_object = TRUE)
bc_index <- get_index(predictions, area = sub$area, bias_correct = TRUE)

# north of 42
sub <- dplyr::filter(expanded_grid, survey=="WCBTS", lat >= 42)
predictions <- predict(fit, newdata = sub, return_tmb_object = TRUE)
wc_north_index <- get_index(predictions, area = sub$area, bias_correct = TRUE)

# South of 42 deg
sub <- dplyr::filter(expanded_grid, survey=="WCBTS", lat < 42)
predictions <- predict(fit, newdata = sub, return_tmb_object = TRUE)
wc_south_index <- get_index(predictions, area = sub$area, bias_correct = TRUE)

sub <- dplyr::filter(expanded_grid, survey=="WCBTS")
predictions <- predict(fit, newdata = sub, return_tmb_object = TRUE)
usa_index <- get_index(predictions, area = sub$area, bias_correct = TRUE)

predictions <- predict(fit, newdata = expanded_grid, return_tmb_object = TRUE)
coastwide_index <- get_index(predictions, area = expanded_grid$area, bias_correct = TRUE)

coastwide_index$type <- "Total"
bc_index$type <- "British Columbia"
wc_north_index$type <- "West Coast USA (N of 42)"
wc_south_index$type <- "West Coast USA (S of 42)"
usa_index$type <- "West Coast of USA"

saveRDS(coastwide_index,"coastwide_index.rds")
saveRDS(bc_index,"bc_index_2003_2023.rds")
saveRDS(wc_north_index,"wc_north_index_2003_2023.rds")
saveRDS(wc_south_index,"wc_south_index_2003_2023.rds")
saveRDS(usa_index,"usa_index.rds")

# 

p2 <- ggplot(rbind(wc_north_index, wc_south_index, bc_index), aes(year, est, col = type, fill = type)) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha=0.6, col=NA) + 
  geom_line() + 
  scale_fill_viridis_d(option="magma", begin = 0.2, end = 0.8, name = "Index") + 
  scale_color_viridis_d(option="magma", begin = 0.2, end = 0.8, name = "Index") + 
  theme_bw() + 
  ylab("Estimate") + 
  xlab("Year")
ggsave(p2, filename = "Indices_2003_2023.png", width=7, height=5)


```
